<!DOCTYPE html>
<html lang="en"><meta charset="utf-8"><meta name="generator" content="Hugo 0.152.2"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="color-scheme" content="light dark">
<meta name="supported-color-schemes" content="light dark"><meta name="description" content="Problem
The Severless Framework package command claims to be useful in CI/CD workflows. The command results in the production of AWS Cloud Formation stack json files (or alternative cloud provider equivalent) on disk. These files can be bundled and considered the &lsquo;deployment artifact&rsquo; at the end of the pipeline. The artifact can be provided to the serverless deploy command that could be run at a later date.
This two-step package/deploy process is very familiar, so I was lured into using the serverless package command. However, there is a major flaw in the design!"><title>Serverless package done right&nbsp;&ndash;&nbsp;Tech Nick</title><link rel="stylesheet" href="/css/core.min.952a6d39cb50fac3eaa9e4386dd02bf0c2457e47928bc76ee18de871a100fec5835856656a5dc80bd4fb6f951cc004f3.css" integrity="sha384-lSptOctQ&#43;sPqqeQ4bdAr8MJFfkeSi8du4Y3ocaEA/sWDWFZlal3IC9T7b5UcwATz"><meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="Serverless package done right" /><body><section id="header">
    <div class="header wrap"><span class="header left-side"><a class="site home" href="/"><span class="site name">Tech Nick</span></a></span>
        <span class="header right-side"><div class="nav wrap"><nav class="nav"><a class="nav item" href="https://nickblair%2edev/"target="_blank" rel="noopener noreferrer">About</a></nav></div></span></div></section><section id="content"><div class="article-container"><section class="article header">
    <h1 class="article title">Serverless package done right</h1><p class="article date">2019-04-01</p></section><article class="article markdown-body"><h2 id="problem">Problem</h2>
<p>The Severless Framework <a href="https://serverless.com/framework/docs/providers/aws/guide/packaging/"target="_blank" rel="noopener noreferrer">package command</a> claims to be useful in CI/CD workflows. The command results in the production of AWS Cloud Formation stack json files (or alternative cloud provider equivalent) on disk. These files can be bundled and considered the &lsquo;deployment artifact&rsquo; at the end of the pipeline. The artifact can be provided to the <code>serverless deploy</code> command that could be run at a later date.</p>
<p>This two-step package/deploy process is very familiar, so I was lured into using the <code>serverless package</code> command. However, there is a major flaw in the design!</p>
<p>The behaviour of the command is to &lsquo;bake in&rsquo; the value of the expected environment variables or <a href="https://aws.amazon.com/systems-manager/features/#Parameter_Store"target="_blank" rel="noopener noreferrer">AWS Parameter Store</a> keys. This means your artifacts are not environment-agnostic. For example, if you include the stage parameter in the name of any functions or resources then the value of the stage parameter will be hardcoded in the artifacts. You therefore cannot promote these artifacts to any stage other than the one named when <code>serverless package</code> was called.</p>
<h2 id="environment-agnostic">Environment Agnostic</h2>
<p>Build artifacts are supposed to be environment-agnostic. You should be able to deploy your artifacts to any environment and &lsquo;promote&rsquo; through to production if desired. Artifacts must therefore be parameterised such that the target environment can provide everything the application needs. This is done using <a href="https://12factor.net/config"target="_blank" rel="noopener noreferrer">environment variables</a>. The only &lsquo;static&rsquo; value in the artifact should be the version number, provided at build time.</p>
<p>One option to side-step this problem is to perform the package step once per potential target environment. A deployment would require the versioned artifacts for the target environment. This option is cumbersome during the build phase and complicates the deploy phase. However, the main problem is the potential for the baked-in environment variables to become stale.</p>
<p>Let&rsquo;s say we change the value of an environment variable after packaging for the production environment. This would require all the existing production-targeted artifacts to be rebuilt so as to bake-in the latest value. Only then are the new packages fit to be deployed. This creates CI overhead and requires consideration of how far back through artifact version history is sensible to rebuild.</p>
<h2 id="just-in-time-packaging">Just-in-time Packaging</h2>
<p>The only realistic option is to postpone the package step, i.e. don&rsquo;t call <code>serverless package</code> explicitly. The package command is implicitly called within the deploy command (as long as the <code>--package</code> parameter is not provided). This package command deference is what happens when you call <code>serverless deploy</code> against your serverless.yml. The environment variables are baked-in &lsquo;just-in-time&rsquo; so the artifacts are fit for the target environment.</p>
<p>We need to bring just-in-time packaging to CI to produce environment-agnostic build artifacts. The solution is to neglect the <code>serverless package</code> command and include the serverless.yml file into the build artifact. The deployment tooling must then execute the <code>serverless deploy</code> command against the serverless.yml from within the artifact sometime later.</p>
<p>To make the bundle completely self-contained the <code>package.json</code> file is also required alongside the serverless.yml. You could include your node_modules folder, or simply your <code>package-lock.json</code> or <code>yarn.lock</code> file and include a call to restore packages before <code>serverless deploy</code> is called, as shown below:</p>
<p>Build artifact contents</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ tree ./deploy
</span></span><span style="display:flex;"><span>.
</span></span><span style="display:flex;"><span>├── package.json
</span></span><span style="display:flex;"><span>├── package.zip <span style="color:#616e87;font-style:italic"># code bundle</span>
</span></span><span style="display:flex;"><span>├── serverless.yml
</span></span><span style="display:flex;"><span>└── yarn.lock
</span></span></code></pre></div><p>Serverless.yml package snippet</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#81a1c1">package</span><span style="color:#eceff4">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#81a1c1">artifact</span><span style="color:#eceff4">:</span> package.zip
</span></span></code></pre></div><p>Deployment steps</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ <span style="color:#81a1c1">cd</span> ./deploy
</span></span><span style="display:flex;"><span>$ yarn install
</span></span><span style="display:flex;"><span>$ yarn run serverless deploy --stage prod
</span></span></code></pre></div></article><section class="article labels"><a class="tag" href=/tags/aws/>aws</a><a class="tag" href=/tags/parameter-store/>parameter-store</a><a class="tag" href=/tags/serverless/>serverless</a><a class="tag" href=/tags/bash/>bash</a></section><section class="article author"><img alt="" loading="lazy" class="avatar" src="/img/avatar.jpg"/><div class="details"><a class="item" href="https://github.com/blair55" target="_blank" rel="noopener noreferrer"><span class="iconfont icon-github"></span>&nbsp;blair55</a><a class="item" href="https://bsky.app/profile/nickblair.dev" target="_blank" rel="noopener noreferrer"><span class="iconfont"><img style="width: 1em; margin-bottom: -2px;" src="/img/bluesky.svg" alt="Bluesky"/></span>&nbsp;@nickblair.dev</a></div>
</section>
</div>
<div class="article bottom"><section class="article navigation"><p><a class="link" href="/blog/combining-monads/"><span class="iconfont icon-article"></span>Combining monads</a></p><p><a class="link" href="/blog/squash-git-commits/"><span class="iconfont icon-article"></span>Squash Git Commits</a></p></section></div></section><section id="footer"><div class="footer-wrap">
    <p class="copyright">Tech Nick</p>
    <p class="powerby"><span>Powered&nbsp;by&nbsp;</span><a href="https://gohugo.io" 
        target="_blank" rel="noopener noreferrer">Hugo</a><span>&nbsp;&amp;&nbsp;</span><a href="https://themes.gohugo.io/hugo-notepadium/" 
        target="_blank" rel="noopener noreferrer">Notepadium</a></p></div></section></body>

</html>